<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="VectorByte Team">

<title>Non-Linear Least Squares (NLLS) and Thermal Performance Curve Fitting with Bootstrapping</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://www.vectorbyte.org" class="navbar-brand navbar-brand-logo">
    <img src="./graphics/vblogoedit.pdf" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./schedule2023.html"> 
<span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/VectorByteOrg/vectorbyte-training4"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/vectorbite_rcn"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#nlls" id="toc-nlls" class="nav-link active" data-scroll-target="#nlls">NLLS</a>
  <ul class="collapse">
  <li><a href="#welcome-to-the-vectorbite-2021-section-on-non-linear-least-squares-nlls" id="toc-welcome-to-the-vectorbite-2021-section-on-non-linear-least-squares-nlls" class="nav-link" data-scroll-target="#welcome-to-the-vectorbite-2021-section-on-non-linear-least-squares-nlls">Welcome to the VectorBiTE 2021 section on Non-linear Least-squares (NLLS)</a></li>
  </ul></li>
  <li><a href="#model-fitting-using-non-linear-least-squares" id="toc-model-fitting-using-non-linear-least-squares" class="nav-link" data-scroll-target="#model-fitting-using-non-linear-least-squares">Model Fitting using Non-linear Least-squares</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#traits-data-as-an-example" id="toc-traits-data-as-an-example" class="nav-link" data-scroll-target="#traits-data-as-an-example">Traits data as an example</a></li>
  <li><a href="#biochemical-kinetics" id="toc-biochemical-kinetics" class="nav-link" data-scroll-target="#biochemical-kinetics">Biochemical Kinetics</a>
  <ul class="collapse">
  <li><a href="#generating-data" id="toc-generating-data" class="nav-link" data-scroll-target="#generating-data">Generating data</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model">Fitting the model</a></li>
  </ul></li>
  <li><a href="#confidence-intervals" id="toc-confidence-intervals" class="nav-link" data-scroll-target="#confidence-intervals">Confidence Intervals</a></li>
  <li><a href="#r-squared-values" id="toc-r-squared-values" class="nav-link" data-scroll-target="#r-squared-values">R-squared values</a></li>
  <li><a href="#the-starting-values-problem" id="toc-the-starting-values-problem" class="nav-link" data-scroll-target="#the-starting-values-problem">The starting values problem</a></li>
  <li><a href="#a-more-robust-nlls-algorithm" id="toc-a-more-robust-nlls-algorithm" class="nav-link" data-scroll-target="#a-more-robust-nlls-algorithm">A more robust NLLS algorithm</a></li>
  <li><a href="#bounding-parameter-values" id="toc-bounding-parameter-values" class="nav-link" data-scroll-target="#bounding-parameter-values">Bounding parameter values</a></li>
  <li><a href="#diagnostics-of-an-nlls-fit" id="toc-diagnostics-of-an-nlls-fit" class="nav-link" data-scroll-target="#diagnostics-of-an-nlls-fit">Diagnostics of an NLLS fit</a></li>
  <li><a href="#abundance-data-as-an-example" id="toc-abundance-data-as-an-example" class="nav-link" data-scroll-target="#abundance-data-as-an-example">Abundance data as an example</a></li>
  <li><a href="#population-growth-rates" id="toc-population-growth-rates" class="nav-link" data-scroll-target="#population-growth-rates">Population growth rates</a>
  <ul class="collapse">
  <li><a href="#using-ols" id="toc-using-ols" class="nav-link" data-scroll-target="#using-ols">Using OLS</a></li>
  <li><a href="#using-nlls" id="toc-using-nlls" class="nav-link" data-scroll-target="#using-nlls">Using NLLS</a></li>
  </ul></li>
  <li><a href="#some-tips-and-tricks-for-nlls-fitting" id="toc-some-tips-and-tricks-for-nlls-fitting" class="nav-link" data-scroll-target="#some-tips-and-tricks-for-nlls-fitting">Some tips and tricks for NLLS fitting</a>
  <ul class="collapse">
  <li><a href="#starting-values" id="toc-starting-values" class="nav-link" data-scroll-target="#starting-values">Starting values</a></li>
  <li><a href="#bounding-parameters-revisited" id="toc-bounding-parameters-revisited" class="nav-link" data-scroll-target="#bounding-parameters-revisited">Bounding parameters revisited</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#example-aedes-aegypti-juvenile-mortality-rate" id="toc-example-aedes-aegypti-juvenile-mortality-rate" class="nav-link" data-scroll-target="#example-aedes-aegypti-juvenile-mortality-rate">Example: Aedes aegypti Juvenile Mortality Rate</a>
  <ul class="collapse">
  <li><a href="#readings-and-resources" id="toc-readings-and-resources" class="nav-link" data-scroll-target="#readings-and-resources">Readings and Resources</a></li>
  <li><a href="#practice-problem-for-nlls" id="toc-practice-problem-for-nlls" class="nav-link" data-scroll-target="#practice-problem-for-nlls">Practice Problem for NLLS</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Non-Linear Least Squares (NLLS) and Thermal Performance Curve Fitting with Bootstrapping</h1>
<p class="subtitle lead">Fitting nonlinear models; TPCs</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>VectorByte Team </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p><a href="materials.html">Main Materials</a></p>
<p>We will use the following packages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("padpadpadpad/rTPC") ## to install rTPC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'rTPC'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'minpack.lm'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'nls.multstart'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'broom'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'tidyverse'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'data.table'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'car'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'boot'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">'patchwork'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="nlls" class="level1">
<h1>NLLS</h1>
<section id="welcome-to-the-vectorbite-2021-section-on-non-linear-least-squares-nlls" class="level3">
<h3 class="anchored" data-anchor-id="welcome-to-the-vectorbite-2021-section-on-non-linear-least-squares-nlls">Welcome to the VectorBiTE 2021 section on Non-linear Least-squares (NLLS)</h3>
<p>This section will cover: * Model Fitting using Non-linear Least-squares * Bootstrapping using the rTPC package</p>
</section>
</section>
<section id="model-fitting-using-non-linear-least-squares" class="level1">
<h1>Model Fitting using Non-linear Least-squares</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this section, you will learn to fit non-linear mathematical models to data using Non-Linear Least Squares (NLLS).</p>
<p>Specifically, you will learn to</p>
<ul>
<li>Visualize the data and the mathematical model you want to fit to them</li>
<li>Fit a non-linear model</li>
<li>Assess the quality of the fit, and whether the model is appropriate for your data</li>
</ul>
<p>This section assumes that you have at least a conceptual understanding of what Linear vs Non-linear models are, how they are fitted to data, and how the fits can be assessed statistically.</p>
<p>We will use R. For starters, clear all variables and graphic devices and load necessary packages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">graphics.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="traits-data-as-an-example" class="level2">
<h2 class="anchored" data-anchor-id="traits-data-as-an-example">Traits data as an example</h2>
<p>Our first set of examples will focus on traits.</p>
<p>A trait is any measurable feature of an individual organism. This includes physical traits (e.g., morphology, body mass, wing length), performance traits (e.g., biochemical kinetics, respiration rate, body velocity, fecundity), and behavioral traits (e.g., feeding preference, foraging strategy, mate choice). All natural populations show variation in traits across individuals. A trait is functional when it directly (e.g., mortality rate) or indirectly (e.g., somatic development or growth rate) determines individual fitness. Therefore, variation in (functional) traits can generate variation in the rate of increase and persistence of populations. When measured in the context of life cycles, without considering interactions with other organisms (e.g., predators or prey of the focal population), functional traits are typically called life history traits (such as mortality rate and fecundity). Other traits determine interactions both within the focal population (e.g., intra-specific interference or mating frequency) and between the focal population/species and others, including the species which may act as resources (prey, for example). Thus both life history and interaction traits determine population fitness and therefore abundance, which ultimately influences dynamics and functioning of the wider ecosystem, such as carbon fixation rate or disease transmission rate.</p>
</section>
<section id="biochemical-kinetics" class="level2">
<h2 class="anchored" data-anchor-id="biochemical-kinetics">Biochemical Kinetics</h2>
<p>The properties of an organism’s metabolic pathways, and the underlying (enzyme-mediated) biochemical reactions (kinetics) are arguably its most fundamental “traits”, because these drive all “performance” traits, from photosynthesis and respiration, to movement and growth rate.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Michaelis%E2%80%93Menten_kinetics">Michaelis-Menten</a> model is widely used to quantify reaction kinetics data and estimate key biochemical parameters. This model relates biochemical reaction rate (<span class="math inline">V</span>) (rate of formation of the product of the reaction), to concentration of the substrate (<span class="math inline">S</span>):</p>
<p><span class="math display">
V = \frac{V_{\max} S}{K_M + S}
</span></p>
<p>Here,</p>
<ul>
<li><span class="math inline">V_{\max}</span> is the maximum rate that can be achieved in the reaction system, which happens at saturating substrate concentration, and</li>
<li><span class="math inline">K_M</span> is the Michaelis or half-saturation constant, defined as the substrate concentration at which the reaction rate is half of <span class="math inline">V_{\max }</span>.</li>
</ul>
<p>Biochemical reactions involving a single substrate are often well fitted by the Michaelis-Menten kinetics, suggesting that its assumptions are often valid.</p>
<p><img src="../graphics/MM.png" alt="Michaelis-Menten model" width="400px"></p>
<p><small></small></p><small>
<center>
The Michaelis-Menten model.
</center>
</small><p><small></small></p>
<p>Let’s fit the Michaelis-Menten model to some data.</p>
<section id="generating-data" class="level3">
<h3 class="anchored" data-anchor-id="generating-data">Generating data</h3>
<p>Instead of using real experimental data, we will actually <em>generate</em> some “data” because that way we know exactly what the errors in the data are. You can also import and use your own dataset for the fitting steps further below.</p>
<p>We can generate some data as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>S_data <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">50</span>,<span class="dv">1</span>) <span class="co"># Generate a sequence of substrate concentrations</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>S_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>V_data <span class="ot">&lt;-</span> ((<span class="fl">12.5</span> <span class="sc">*</span> S_data)<span class="sc">/</span>(<span class="fl">7.1</span> <span class="sc">+</span> S_data)) <span class="co"># Generate a Michaelis-Menten response with V_max = 12.5 and K_M = 7.1</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(S_data, V_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that our choice of <span class="math inline">V_{\max} = 12.5</span> and <span class="math inline">K_M = 7.1</span> is completely arbitrary. As long as we make sure that <span class="math inline">V_{\max} &gt; 0</span>, <span class="math inline">K_H &gt; 0</span>, and <span class="math inline">K_M</span> lies well within the lower half of the the range of substrate concentrations (0-50), these “data” will be physically biologically sensible.</p>
<p>Now let’s add some random (normally-distributed) fluctuations to the data to emulate experimental / measurement error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1456</span>) <span class="co"># To get the same random fluctuations in the "data" every time</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>V_data <span class="ot">&lt;-</span> V_data <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">50</span>,<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Add random fluctuations to emulate error with standard deviation of 0.5</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(S_data, V_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That looks real!</p>
</section>
<section id="fitting-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-model">Fitting the model</h3>
<p>Now, fit the model to the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>MM_model <span class="ot">&lt;-</span> <span class="fu">nls</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in nls(V_data ~ V_max * S_data/(K_M + S_data)): No starting values specified for some parameters.
Initializing 'V_max', 'K_M' to '1.'.
Consider specifying 'start' or using a selfStart model</code></pre>
</div>
</div>
<p>This warning arises because <code>nls</code> requires “starting values” for the parameters (two in this case: <code>V_max</code> and <code>K_M</code>) to start searching for optimal combinations of parameter values (ones that minimize the RSS). Indeed, all NLLS fitting functions / algorithms require this. If you do not provide starting values, <code>nls</code> gives you a warning (as above) and uses a starting value of 1 for every parameter by default. For simple models, despite the warning, this works well enough.</p>
<div class="cell">
<pre class="tip cell-code"><code>Before proceeding further, have a look at what `nls()`'s arguments are using `?nls`, or looking at the documentation [online](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/nls).</code></pre>
</div>
<p>We will address the issue of starting values soon enough, but first let’s look at how good the fit that we obtained looks. The first thing to do is to see how well the model fitted the data, for which plotting is the best first option:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(S_data,V_data, <span class="at">xlab =</span> <span class="st">"Substrate Concentration"</span>, <span class="at">ylab =</span> <span class="st">"Reaction Rate"</span>)  <span class="co"># first plot the data </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(S_data,<span class="fu">predict</span>(MM_model),<span class="at">lty=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">lwd=</span><span class="dv">2</span>) <span class="co"># now overlay the fitted model </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks pretty good.</p>
<p>Note that we used we used the <code>predict()</code> function here just as we did in any of the linear models sections.</p>
<div class="cell">
<pre class="note cell-code"><code>In general, you can use most of the same commands/functions (e.g., `predict()` and `summary()`) on the output of a `nls()` model fitting object as you would on a `lm()` model fitting object.</code></pre>
</div>
<p>Now lets get some stats of this NLLS fit. Having obtained the fit object (<code>MM_model</code>), we can use <code>summary()</code> just like we would for a <code>lm()</code> fit object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(MM_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: V_data ~ V_max * S_data/(K_M + S_data)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)    
V_max  13.5041     0.5345  25.265  &lt; 2e-16 ***
K_M     9.4085     1.3198   7.128 4.67e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.001 on 48 degrees of freedom

Number of iterations to convergence: 7 
Achieved convergence tolerance: 1.948e-06</code></pre>
</div>
</div>
<p>This looks a lot like the output of a linear model, and to be specific, of a Linear Regression. For starters, compare the above output with the output of <code>summary(genomeSizeModelDragon)</code> the linear regression section.</p>
<p>So here are the main things to note about the output of <code>summary()</code> of an <code>nls()</code> model object:</p>
<ul>
<li><code>Estimate</code>s are, as in the output of the <code>lm()</code> function for fitting linear models, the estimated values of the coefficients of the model that you fitted (<span class="math inline">V_(\max)</span> and <span class="math inline">K_M</span>). Note that although we generated our data using <span class="math inline">V_{\max} = 12.5</span> and <span class="math inline">K_M = 7.1</span>, the actual coefficients are quite different from what we are getting with the NLLS fitting ( <span class="math inline">\hat{V_{\max} = 13.5</span> and <span class="math inline">\hat{K}_M = 9.4</span>). This is because we introduced random (normally-distributed) errors. This tell you something about how experimental and/or measurement errors can distort your image of the underlying mechanism or process.<br>
</li>
<li><code>Std. Error</code>, <code>t value</code>, and <code>Pr(&gt;|t|)</code> and <code>Residual standard error</code> have the same interpretation as in the output of <code>lm()</code> (please look back at the Linear Regression section)</li>
<li><code>Number of iterations to convergence</code> tells you how many times the NLLS algorithm had to adjust the parameter values till it managed to find a solution that minimizes the Residual Sum of Squares (RSS)</li>
<li><code>Achieved convergence tolerance</code> tells you on what basis the algorithm decided that it was close enough to the a solution; basically if the RSS does not improve more than a certain threshold despite parameter adjustments, the algorithm stops searching. This may or may not be close to an optimal solution (but in this case it is).</li>
</ul>
<p>The last two items are specific to the output of an <code>nls()</code> fitting <code>summary()</code>, because unlike Ordinary Least Squares (OLS), which is what we used for Linear regression, NLLS is not an <em>exact</em> procedure, and the fitting requires computer simulations. As such, you do not need to report these last two items when presenting the results of an NLLS fit, but they are useful for problem solving in case the fitting does not work (more on this below).</p>
<p>As noted above, you can use the same sort of commands on a <code>nls()</code> fitting result as you can on a <code>lm()</code> object.</p>
<p>For example, you can get just the values of the estimated coefficients using:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504118  9.408462 </code></pre>
</div>
</div>
<p>Thus, much of the output of NLLS fitting using <code>nls()</code> is analogous to the output of an <code>lm()</code>. However, further statistical inference here cannot be done using Analysis of Variance (ANOVA), because the model is not a Linear Model. Try <code>anova(MM_model)</code>, and see what happens. We will address statistical inference with NLLS model fitting further below (with a different example).</p>
</section>
</section>
<section id="confidence-intervals" class="level2">
<h2 class="anchored" data-anchor-id="confidence-intervals">Confidence Intervals</h2>
<p>One particularly useful thing you can do after NLLS fitting is to calculate/construct the confidence intervals (CI’s) around the estimated parameters in our fitted model, analogous to how we would in the OLS fitting used for Linear Models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(MM_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Waiting for profiling to be done...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>           2.5%    97.5%
V_max 12.538677 14.66093
K_M    7.124685 12.36158</code></pre>
</div>
</div>
<p>The <code>Waiting for profiling to be done...</code> message reflects the fact that calculating the standard errors from which the CI’s are calculated requires a particular computational procedure (which we will not go into here) when it comes to NLLS fits. Calculating confidence intervals can be useful because you can use a coefficient/parameter estimate’s confidence intervals to test whether it is significantly different from some reference value. Note that the intervals for <code>K_M</code> do not include the original value of <span class="math inline">K_M = 7.1</span> that we used to generate the data!.</p>
<p>Also, the intervals should not include zero for the coefficient to be statistically significant in itself, that is, different from zero.</p>
</section>
<section id="r-squared-values" class="level2">
<h2 class="anchored" data-anchor-id="r-squared-values">R-squared values</h2>
<p>To put it simply, unlike an R<span class="math inline">^2</span> value obtained by fitting a linear model, that obtained from NLLS fitting is not reliable, and should not be used. The reason for this is somewhat technical (e.g., see this <a href="https://dx.doi.org/10.1186%2F1471-2210-10-6">paper</a>) and we won’t go into it here. But basically, NLLS R<span class="math inline">^2</span> values do not always accurately reflect the quality of fit, and definitely cannot be used to select between competing models. Indeed R<span class="math inline">^2</span> values obtained from NLLS fitting even be negative when the model fits very poorly! We will learn more about model selection with non-linear models later below.</p>
</section>
<section id="the-starting-values-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-starting-values-problem">The starting values problem</h2>
<p>Now let’s revisit the issue of starting values in NLLS fitting. Previously, we fitted the Michaelis-Menten Model without any starting values, and R gave us a warning but managed to fit the model to our synthetic “data” using default starting values.</p>
<p>Lets try the NLLS fitting again, but with some particular starting values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>MM_model2 <span class="ot">&lt;-</span> <span class="fu">nls</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="dv">2</span>, <span class="at">K_M =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that unlike before, we got no warning message about starting values.</p>
<p>Let’s compare the coefficient estimates from our two different model fits to the same dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504118  9.408462 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504105  9.408426 </code></pre>
</div>
</div>
<p>Not too different, but not exactly the same!</p>
<p>In contrast, when you fit linear models you will get exactly the same coefficient estimates every single time, because OLS is an <em>exact</em> procedure.</p>
<p>Now, let’s try even more different start values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>MM_model3 <span class="ot">&lt;-</span> <span class="fu">nls</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> .<span class="dv">01</span>, <span class="at">K_M =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compare the coefficients of this model fit to the two previous ones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504118  9.408462 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504105  9.408426 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
 2.956160 -3.474732 </code></pre>
</div>
</div>
<p>The estimates in our latest model fit are completely different (in fact, <code>K_M</code> is negative)! Let’s plot this model’s and the first model’s fit together:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(S_data,V_data)  <span class="co"># first plot the data </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(S_data,<span class="fu">predict</span>(MM_model),<span class="at">lty=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">lwd=</span><span class="dv">2</span>) <span class="co"># overlay the original model fit</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(S_data,<span class="fu">predict</span>(MM_model3),<span class="at">lty=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">"red"</span>,<span class="at">lwd=</span><span class="dv">2</span>) <span class="co"># overlay the latest model fit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As you would have guessed from the really funky coefficient estimates that were obtained in <code>MM_model3</code>, this is a pretty poor model fit to the data, with the negative value of <code>K_M</code> causing the fitted version of the Michaelis-Menten model to behave strangely.</p>
<p>Let’s try with even more different starting values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nls</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="dv">0</span>, <span class="at">K_M =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Try putting a zero for the starting V_max value. You’ll get an error. The <code>singular gradient matrix at initial parameter estimates</code> error arises from the fact that the starting values you provided were so far from the optimal solution, that the parameter searching in <code>nls()</code> failed at the very first step. The algorithm could not figure out where to go from those starting values. In fact, the starting value we gave it is biologically/ physically impossible, because <code>V_max</code> can’t really equal 0.</p>
<p>Let’s look at some more starting values that can cause the model fitting to fail:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nls</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="fl">0.1</span>, <span class="at">K_M =</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nls</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">K_M =</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In both the above cases, the model fitting was able to start, but eventually failed because the starting values were too far from the (approximately) optimal values (<span class="math inline">V_{\max} \approx 13.5, K_M \approx 9.4</span>).</p>
<p>And what happens if we start really close to the optimal values? Let’s try:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>MM_model4 <span class="ot">&lt;-</span> <span class="fu">nls</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="fl">13.5</span>, <span class="at">K_M =</span> <span class="fl">9.4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504118  9.408462 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504102  9.408419 </code></pre>
</div>
</div>
<p>The results of the first model fit and this last one are still not exactly the same! This drives home the point that NLLS is not an “exact” procedure. However, the differences between these two solutions are minuscule, so the main thing to take away is that if the starting values are reasonable, NLLS is <em>exact enough</em>.</p>
<p>Note that and even if you started the NLLS fitting with the exact parameter values with which you generated the data before introducing errors (so use <code>start = list(V_max = 12.5, K_M = 7.1)</code> above instead), you would still get the same result for the coefficients (try it). This is because the NLLS fitting will converge back to the parameter estimates based on the actual data, errors and all.</p>
</section>
<section id="a-more-robust-nlls-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="a-more-robust-nlls-algorithm">A more robust NLLS algorithm</h2>
<p>The standard NLLS function in R, <code>nls</code>, which we have been using so far, does the NLLS fitting by implementing an algorithm called the Gauss-Newton algorithm. While the Gauss-Newton algorithm works well for most simple non-linear models, it has a tendency to “get lost” or “stuck” while searching for optimal parameter estimates (that minimize the residual sum of squares, or RSS). Therefore, <code>nls</code> will often fail to fit your model to the data if you start off at starting values for the parameters that are too far from what the optimal values would be, as you saw above (e.g., when you got the <code>singular gradient matrix</code> error).</p>
<p>Some nonlinear models are especially difficult for nls to fit to data because such model have a mathematical form that makes it hard to find parameter combinations that minimize the residual sum of squared (RSS). If this does not makes sense, don’t worry about it.</p>
<p>One solution to this is to use a different algorithm than Gauss-Newton. <code>nls()</code> has one other algorithm that can be more robust in some situations, called the “port” algorithm. However, there is a better solution still: the Levenberg-Marqualdt algorithm, which is less likely to get stuck (is more robust than) than Gauss-Newton (or port). If you want to learn more about the technicalities of this, <a href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Newton_algorithm">here</a> are <a href="https://en.wikipedia.org/wiki/Levenberg%E2%80%93Marquardt_algorithm">here</a> are good places to start (also see the Readings list at the end of this section).</p>
<p>To be able to use nlsLM, we will need to switch to a different NLLS function called <code>nlsLM</code>. In order to be able to use <code>nlsLM</code>, you will need the <code>nls.lm</code> R package, which you can install using the method appropriate for your operating system (e.g., linux users will launch R in <code>sudo</code> mode first) and then use:</p>
<p>Now let’s use the <code>minpack.lm</code> package:</p>
<p>Let’s try it (using the same starting values as <code>MM_model2</code> above):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>MM_model5 <span class="ot">&lt;-</span> <span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="dv">2</span>, <span class="at">K_M =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now compare the <code>nls</code> and <code>nlsLM</code> fitted coefficients:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504105  9.408426 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504116  9.408456 </code></pre>
</div>
</div>
<p>Close enough.</p>
<p>Now, let’s try fitting the model using all those starting parameter combinations that failed previously:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>MM_model6 <span class="ot">&lt;-</span> <span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="dv">1</span>, <span class="at">K_M =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>MM_model7 <span class="ot">&lt;-</span> <span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="dv">0</span>, <span class="at">K_M =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>MM_model8 <span class="ot">&lt;-</span> <span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="fl">0.1</span>, <span class="at">K_M =</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>MM_model9 <span class="ot">&lt;-</span> <span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">K_M =</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504105  9.408426 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504116  9.408456 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504119  9.408464 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
 6.235507 -1.392507 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504126  9.408482 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(MM_model9)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    V_max       K_M 
13.504115  9.408453 </code></pre>
</div>
</div>
<p>Nice, these all worked with <code>nlsLM</code> even though they had failed with <code>nls</code>! But one of them (model 7) still gives you poor values for the coefficients.</p>
<p>But <code>nlsLM</code> also has its limits. Let’s try more absurd starting values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">K_M =</span> <span class="sc">-</span><span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thus, using starting values that are in a sensible range is always a good idea. Here, we know that neither <span class="math inline">V_{\max}</span> nor <span class="math inline">K_M</span> can be negative, so we can use that bit of information to assign reasonable starting values.</p>
<div class="cell">
<pre class="note cell-code"><code>*How do you find "sensible" starting values for NLLS fitting?* This very much depends on your understanding of the mathematical model that is being fitted to the data, and the mechanistic interpretation of its parameters. </code></pre>
</div>
</section>
<section id="bounding-parameter-values" class="level2">
<h2 class="anchored" data-anchor-id="bounding-parameter-values">Bounding parameter values</h2>
<p>You can also bound the starting values, i.e., prevent them from exceeding some minimum and maximum value <em>during</em> the NLLS fitting process:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="fl">0.5</span>, <span class="at">K_M =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nonlinear regression model
  model: V_data ~ V_max * S_data/(K_M + S_data)
   data: parent.frame()
 V_max    K_M 
13.504  9.408 
 residual sum-of-squares: 48.06

Number of iterations to convergence: 9 
Achieved convergence tolerance: 1.49e-08</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">V_max =</span> <span class="fl">0.5</span>, <span class="at">K_M =</span> <span class="fl">0.5</span>), <span class="at">lower=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.4</span>), <span class="at">upper=</span><span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nonlinear regression model
  model: V_data ~ V_max * S_data/(K_M + S_data)
   data: parent.frame()
 V_max    K_M 
13.504  9.408 
 residual sum-of-squares: 48.06

Number of iterations to convergence: 8 
Achieved convergence tolerance: 1.49e-08</code></pre>
</div>
</div>
<p>So the solution was found in one lesser iteration (not a spectacular improvement, but an improvement nevertheless).</p>
<p>However, if you bound the parameters too much (to excessively narrow ranges), the algorithm cannot search sufficient parameter space (combinations of parameters), and will fail to converge on a good solution. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlsLM</span>(V_data <span class="sc">~</span> V_max <span class="sc">*</span> S_data <span class="sc">/</span> (K_M <span class="sc">+</span> S_data), <span class="at">start =</span>  <span class="fu">list</span>(<span class="at">V_max =</span> <span class="fl">0.5</span>, <span class="at">K_M =</span> <span class="fl">0.5</span>), <span class="at">lower=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.4</span>), <span class="at">upper=</span><span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nonlinear regression model
  model: V_data ~ V_max * S_data/(K_M + S_data)
   data: parent.frame()
V_max   K_M 
17.21 20.00 
 residual sum-of-squares: 78.58

Number of iterations to convergence: 3 
Achieved convergence tolerance: 1.49e-08</code></pre>
</div>
</div>
<p>Here the algorithm converged on a poor solution, and in fact took fewer iterations (3) than before to do so. This is because it could not explore sufficient parameter combinations of <code>V_max</code> and <code>K_M</code> as we have narrowed the range that both these parameters could be allowed to take during the optimization too much.</p>
</section>
<section id="diagnostics-of-an-nlls-fit" class="level2">
<h2 class="anchored" data-anchor-id="diagnostics-of-an-nlls-fit">Diagnostics of an NLLS fit</h2>
<p>NLLS regression carries the same three key assumptions as Linear models:</p>
<ul>
<li><p>No (in practice, minimal) measurement error in explanatory/independent/predictor variable (<span class="math inline">x</span>-axis variable)</p></li>
<li><p>Data have constant normal variance — errors in the <span class="math inline">y</span>-axis are homogeneously distributed over the <span class="math inline">x</span>-axis range</p></li>
<li><p>The measurement/observation errors are Normally distributed (Gaussian)</p></li>
</ul>
<p>At the very least, it is a good idea to plot the residuals of a fitted NLLS model. Let’s do that for our Michaelis-Menten Model fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">residuals</span>(MM_model6))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The residuals look OK. But this should not come as a surprise because we generated these “data” ourselves using normally-distributed errors!</p>
</section>
<section id="abundance-data-as-an-example" class="level2">
<h2 class="anchored" data-anchor-id="abundance-data-as-an-example">Abundance data as an example</h2>
<p>Fluctuations in the abundance (density) of single populations may play a crucial role in ecosystem dynamics and emergent functional characteristics, such as rates of carbon fixation or disease transmission. For example, if vector population densities or their traits change at the same or shorter timescales than the rate of disease transmission, then (vector) abundance fluctuations can cause significant fluctuations in disease transmission rates. Indeed, most disease vectors are small ectotherms with short generation times and greater sensitivity to environmental conditions than their (invariably larger, longer-lived, and often, endothermic) hosts. So understanding how populations vary over time, space, and with respect to environmental variables such as temperature and precipitation is key. We will look at fitting models to the growth of a single population here.</p>
</section>
<section id="population-growth-rates" class="level2">
<h2 class="anchored" data-anchor-id="population-growth-rates">Population growth rates</h2>
<p>A population grows exponentially while its abundance is low and resources are not limiting (the Malthusian principle). This growth then slows and eventually stops as resources become limiting. There may also be a time lag before the population growth really takes off at the start. We will focus on microbial (specifically, bacterial) growth rates. Bacterial growth in batch culture follows a distinct set of phases; lag phase, exponential phase and stationary phase. During the lag phase a suite of transcriptional machinery is activated, including genes involved in nutrient uptake and metabolic changes, as bacteria prepare for growth. During the exponential growth phase, bacteria divide at a constant rate, the population doubling with each generation. When the carrying capacity of the media is reached, growth slows and the number of cells in the culture stabilizes, beginning the stationary phase.</p>
<p>Traditionally, microbial growth rates were measured by plotting cell numbers or culture density against time on a semi-log graph and fitting a straight line through the exponential growth phase – the slope of the line gives the maximum growth rate (<span class="math inline">r_{max}</span>). Models have since been developed which we can use to describe the whole sigmoidal bacterial growth curve (e.g., using NLLS). Here we will take a look at these different approaches, from applying linear models to the exponential phase, through to fitting non-linear models to the full growth curve.</p>
<p>Let’s first generate some “data” on the number of bacterial cells as a function of time that we can play with:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">22</span>, <span class="dv">2</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">32500</span>, <span class="dv">33000</span>, <span class="dv">38000</span>, <span class="dv">105000</span>, <span class="dv">445000</span>, <span class="dv">1430000</span>, <span class="dv">3020000</span>, <span class="dv">4720000</span>, <span class="dv">5670000</span>, <span class="dv">5870000</span>, <span class="dv">5930000</span>, <span class="dv">5940000</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>) <span class="co"># set seed to ensure you always get the same random sequence </span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(t, N <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="at">sd =</span> <span class="fl">0.1</span>))) <span class="co"># add some random error</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Time"</span>, <span class="st">"N"</span>)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Time          N
1    0   28577.04
2    2   33915.52
3    4   42120.88
4    6   80370.17
5    8  464096.05
6   10 1502365.99</code></pre>
</div>
</div>
<p>Note how we added some random “sampling” error using <code>N * (1 + rnorm(length(t), sd = .1))</code>.</p>
<p>This means that we are adding an error at each time point <span class="math inline">t</span> (let’s call this fluctuation <span class="math inline">\epsilon_t</span>) as a * percentage * of the population (<span class="math inline">N_t</span>) at that time point in a vectorized way. That is, we are performing the operation <span class="math inline">N_t \times (1 + \epsilon_t)</span> at all time points at one go. This is important to note because this is often the way that errors appear – proportional to the value being measured.</p>
<p>Now let’s plot these data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> N)) <span class="sc">+</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time (Hours)"</span>, <span class="at">y =</span> <span class="st">"Population size (cells)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="basic-approach" class="level4">
<h4 class="anchored" data-anchor-id="basic-approach">Basic approach</h4>
<p>The size of an exponentially growing population (<span class="math inline">N</span>) at any given time (<span class="math inline">t</span>) is given by:</p>
<p>$ N(t) = N_0 e^{rt}$</p>
<p>where <span class="math inline">N_0</span> is the initial population size and <span class="math inline">r</span> is the growth rate. We can re-arrange this to give:</p>
<p><span class="math inline">r = \frac{\log(N(t)) - \log(N_0)}{t}</span></p>
<p>That is, in exponential growth at a constant rate, the growth rate can be simply calculated as the difference in the log of two population sizes, over time. We will log-transform the data and estimate by eye where growth looks exponential.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>LogN <span class="ot">&lt;-</span> <span class="fu">log</span>(data<span class="sc">$</span>N)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co"># visualise</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> LogN)) <span class="sc">+</span> </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time (Hours)"</span>, <span class="at">y =</span> <span class="st">"log(cell number)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>By eye the logged data looks fairly linear (beyond the initial “lag phase” of growth; see below) between hours 5 and 10, so we’ll use that time-period to calculate the growth rate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>(data[data<span class="sc">$</span>Time <span class="sc">==</span> <span class="dv">10</span>,]<span class="sc">$</span>LogN <span class="sc">-</span> data[data<span class="sc">$</span>Time <span class="sc">==</span> <span class="dv">6</span>,]<span class="sc">$</span>LogN)<span class="sc">/</span>(<span class="dv">10-6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7320383</code></pre>
</div>
</div>
<p>This is our first, most basic estimate of <span class="math inline">r</span>.</p>
<p>Or, we can decide not to eyeball the data, but just pick the maximum observed gradient of the curve. For this, we can use the the <code>diff()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span>(data<span class="sc">$</span>LogN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  0.171269154  0.216670872  0.646099643  1.753448393  1.174704941
 [6]  0.639023868  0.449529740  0.181493482 -0.000450184  0.054490710
[11] -0.054600924</code></pre>
</div>
</div>
<p>This gives all the (log) population size differences between successive timepoint pairs. The max of this is what we want, divided by the time-step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">diff</span>(data<span class="sc">$</span>LogN))<span class="sc">/</span><span class="dv">2</span> <span class="co"># 2 is the difference in any successive pair of timepoints</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8767242</code></pre>
</div>
</div>
</section>
<section id="using-ols" class="level3">
<h3 class="anchored" data-anchor-id="using-ols">Using OLS</h3>
<p>But we can do better than this. To account for some error in measurement, we shouldn’t really take the data points directly, but fit a linear model through them instead, where the slope gives our growth rate. This is pretty much the “traditional” way of calculating microbial growth rates – draw a straight line through the linear part of the log-transformed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>lm_growth <span class="ot">&lt;-</span> <span class="fu">lm</span>(LogN <span class="sc">~</span> Time, <span class="at">data =</span> data[data<span class="sc">$</span>Time <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>Time <span class="sc">&lt;</span> <span class="dv">12</span>,])</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_growth)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LogN ~ Time, data = data[data$Time &gt; 2 &amp; data$Time &lt; 
    12, ])

Residuals:
       3        4        5        6 
 0.21646 -0.38507  0.12076  0.04785 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)   7.9366     0.5350  14.835  0.00451 **
Time          0.6238     0.0728   8.569  0.01335 * 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3256 on 2 degrees of freedom
Multiple R-squared:  0.9735,    Adjusted R-squared:  0.9602 
F-statistic: 73.42 on 1 and 2 DF,  p-value: 0.01335</code></pre>
</div>
</div>
<p>Npw we get <span class="math inline">r \approx 0.62</span>, which is probably closer to the “truth”.</p>
<p>But this is still not ideal because we only guessed the exponential phase by eye. We could do it better by iterating through different windows of points, comparing the slopes and finding which the highest is to give the maximum growth rate, <span class="math inline">r_{max}</span>. This is called a “rolling regression”.</p>
<p>Or better still, we can fit a more appropriate mathematical model using NLLS!</p>
</section>
<section id="using-nlls" class="level3">
<h3 class="anchored" data-anchor-id="using-nlls">Using NLLS</h3>
<p>For starters, a classical, (somewhat) mechanistic model is the logistic equation:</p>
<p><span class="math display">
N_t = \frac{N_0 K e^{r t}}{K + N_0 (e^{r t} - 1)}
</span></p>
<p>Here <span class="math inline">N_t</span> is population size at time <span class="math inline">t</span>, <span class="math inline">N_0</span> is initial population size, <span class="math inline">r</span> is maximum growth rate (AKA <span class="math inline">r_\text{max}</span>), and <span class="math inline">K</span> is carrying capacity (maximum possible abundance of the population). Note that this model is actually the solution to the differential equation that defines the classic logistic population growth model.</p>
<p>Let’s fit it to the data. First, we need to define it as a function object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>logistic_model <span class="ot">&lt;-</span> <span class="cf">function</span>(t, r_max, K, N_0){ <span class="co"># The classic logistic equation</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(N_0 <span class="sc">*</span> K <span class="sc">*</span> <span class="fu">exp</span>(r_max <span class="sc">*</span> t)<span class="sc">/</span>(K <span class="sc">+</span> N_0 <span class="sc">*</span> (<span class="fu">exp</span>(r_max <span class="sc">*</span> t) <span class="sc">-</span> <span class="dv">1</span>)))</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now fit it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first we need some starting parameters for the model</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>N_0_start <span class="ot">&lt;-</span> <span class="fu">min</span>(data<span class="sc">$</span>N) <span class="co"># lowest population size</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>K_start <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>N) <span class="co"># highest population size</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>r_max_start <span class="ot">&lt;-</span> <span class="fl">0.62</span> <span class="co"># use our estimate from the OLS fitting from above</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>fit_logistic <span class="ot">&lt;-</span> <span class="fu">nlsLM</span>(N <span class="sc">~</span> <span class="fu">logistic_model</span>(<span class="at">t =</span> Time, r_max, K, N_0), data,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">r_max=</span>r_max_start, <span class="at">N_0 =</span> N_0_start, <span class="at">K =</span> K_start))</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_logistic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: N ~ logistic_model(t = Time, r_max, K, N_0)

Parameters:
       Estimate Std. Error t value Pr(&gt;|t|)    
r_max 6.309e-01  3.791e-02  16.641 4.56e-08 ***
N_0   3.317e+03  1.451e+03   2.286   0.0481 *  
K     5.538e+06  7.192e+04  76.995 5.32e-14 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 119200 on 9 degrees of freedom

Number of iterations to convergence: 12 
Achieved convergence tolerance: 1.49e-08</code></pre>
</div>
</div>
<p>We did not pay much attention to what starting values we used in the simpler example of fitting the allometric model because the power-law model is easy to fit using NLLS, and starting far from the optimal parameters does not matter too much. Here, we used the actual data to generate more realistic start values for each of the three parameters (<code>r_max</code>, <code>N_0</code>, <code>K</code>) of the Logistic equation.</p>
<p>Now, plot the fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>timepoints <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">22</span>, <span class="fl">0.1</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>logistic_points <span class="ot">&lt;-</span> <span class="fu">logistic_model</span>(<span class="at">t =</span> timepoints, </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">r_max =</span> <span class="fu">coef</span>(fit_logistic)[<span class="st">"r_max"</span>], </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">K =</span> <span class="fu">coef</span>(fit_logistic)[<span class="st">"K"</span>], </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">N_0 =</span> <span class="fu">coef</span>(fit_logistic)[<span class="st">"N_0"</span>])</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(timepoints, logistic_points)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>df1<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="st">"Logistic equation"</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Time"</span>, <span class="st">"N"</span>, <span class="st">"model"</span>)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> N)) <span class="sc">+</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_line</span>(<span class="at">data =</span> df1, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> N, <span class="at">col =</span> model), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)<span class="sc">+</span> <span class="co"># make the plot square </span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Cell number"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That looks nice, and the <span class="math inline">r_{max}</span> estimate we get (0.64) is fairly close to what we got above with OLS fitting.</p>
<p>Note that we’ve done this fitting to the original non transformed data, whilst the linear regressions earlier were on log transformed data. What would this function look like on a log-transformed axis?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> LogN)) <span class="sc">+</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_line</span>(<span class="at">data =</span> df1, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> <span class="fu">log</span>(N), <span class="at">col =</span> model), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)<span class="sc">+</span> </span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"log(Cell number)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The model actually diverges from the data at the lower end! This was not visible in the previous plot where you examined the model in linear scale (without taking a log) because the deviation of the model is small, and only becomes clear in the log scale. This is because of the way logarithms work. Let’s have a look at this in our Cell counts “data”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> N, <span class="at">y =</span> LogN)) <span class="sc">+</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>)<span class="sc">+</span> </span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"N"</span>, <span class="at">y =</span> <span class="st">"log(N)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As you can see the logarithm is a strongly nonlinear transformation of any sequence of real numbers, with small numbers close to zero yielding disproportionately large deviations.</p>
<div class="cell">
<pre class="note cell-code"><code>You may play with increasing the error (by increasing the value of `sd` in synthetic data generation step above) and re-evaluating all the subsequent model fitting steps above. However, note that above some values of `sd`, you will start to get negative values of populations, especially at early time points, which will raise issues with taking a logarithm.</code></pre>
</div>
<p>The above seen deviation of the Logistic model from the data is because this model assumes that the population is growing right from the start (Time = 0), while in “reality” (in our synthetic “data”), this is not what’s happening; the population takes a while to grow truly exponentially (i.e., there is a time lag in the population growth). This time lag is seen frequently in the lab, and is also expected in nature, because when bacteria encounter fresh growth media (in the lab) or a new resource/environment (in the field), they take some time to acclimate, activating genes involved in nutrient uptake and metabolic processes, before beginning exponential growth. This is called the lag phase and can be seen in our example data where exponential growth doesn’t properly begin until around the 4th hour.</p>
<p>To capture the lag phase, more complicated bacterial growth models have been designed.</p>
<p>One of these is the modified Gompertz model (Zwietering et. al., 1990), which has been used frequently in the literature to model bacterial growth:</p>
<p><span class="math display">
  \log(N_t) = N_0 + (N_{max} - N_0) e^{-e^{r_{max} \exp(1) \frac{t_{lag} - t}{(N_{max} - N_0) \log(10)} + 1}}
</span></p>
<p>Here maximum growth rate (<span class="math inline">r_{max}</span>) is the tangent to the inflection point, <span class="math inline">t_{lag}</span> is the x-axis intercept to this tangent (duration of the delay before the population starts growing exponentially) and <span class="math inline">\log\left(\frac{N_{max}}{N_0}\right)</span> is the asymptote of the log-transformed population growth trajectory, i.e., the log ratio of maximum population density <span class="math inline">N_{max}</span> (aka “carrying capacity”) and initial cell (Population) <span class="math inline">N_0</span> density.</p>
<div class="cell">
<pre class="note cell-code"><code>Note that unlike the Logistic growth model above, the Gompertz model is in the log scale. This is because the model is not derived from a differential equation, but was designed * specifically * to be fitted to log-transformed data.</code></pre>
</div>
<p>Now let’s fit and compare the two alternative nonlinear growth models: Logistic and Gompertz.</p>
<p>First, specify the function object for the Gompertz model (we already defined the function for the Logistic model above):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>gompertz_model <span class="ot">&lt;-</span> <span class="cf">function</span>(t, r_max, K, N_0, t_lag){ <span class="co"># Modified gompertz growth model (Zwietering 1990)</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(N_0 <span class="sc">+</span> (K <span class="sc">-</span> N_0) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(r_max <span class="sc">*</span> <span class="fu">exp</span>(<span class="dv">1</span>) <span class="sc">*</span> (t_lag <span class="sc">-</span> t)<span class="sc">/</span>((K <span class="sc">-</span> N_0) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">10</span>)) <span class="sc">+</span> <span class="dv">1</span>)))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>}   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, note that unlike the Logistic growth function above, this function has been written in the log scale.</p>
<p>Now let’s generate some starting values for the NLLS fitting of the Gompertz model.</p>
<p>As we did above for the logistic equation, let’s derive the starting values by using the actual data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>N_0_start <span class="ot">&lt;-</span> <span class="fu">min</span>(data<span class="sc">$</span>LogN) <span class="co"># lowest population size, note log scale</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>K_start <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>LogN) <span class="co"># highest population size, note log scale</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>r_max_start <span class="ot">&lt;-</span> <span class="fl">0.62</span> <span class="co"># use our previous estimate from the OLS fitting from above</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>t_lag_start <span class="ot">&lt;-</span> data<span class="sc">$</span>Time[<span class="fu">which.max</span>(<span class="fu">diff</span>(<span class="fu">diff</span>(data<span class="sc">$</span>LogN)))] <span class="co"># find last timepoint of lag phase</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>So how did we find a reasonable time lag from the data? *</li>
</ul>
<p>Let’s break the last command down:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span>(data<span class="sc">$</span>LogN) <span class="co"># same as what we did above - get differentials</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  0.171269154  0.216670872  0.646099643  1.753448393  1.174704941
 [6]  0.639023868  0.449529740  0.181493482 -0.000450184  0.054490710
[11] -0.054600924</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span>(<span class="fu">diff</span>(data<span class="sc">$</span>LogN)) <span class="co"># get the differentials of the differentials (approx 2nd order derivatives)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  0.04540172  0.42942877  1.10734875 -0.57874345 -0.53568107 -0.18949413
 [7] -0.26803626 -0.18194367  0.05494089 -0.10909163</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(<span class="fu">diff</span>(<span class="fu">diff</span>(data<span class="sc">$</span>LogN))) <span class="co"># find the timepoint where this 2nd order derivative really takes off </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Time[<span class="fu">which.max</span>(<span class="fu">diff</span>(<span class="fu">diff</span>(data<span class="sc">$</span>LogN)))] <span class="co"># This then is a good guess for the last timepoint of the lag phase</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>Now fit the model using these start values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>fit_gompertz <span class="ot">&lt;-</span> <span class="fu">nlsLM</span>(LogN <span class="sc">~</span> <span class="fu">gompertz_model</span>(<span class="at">t =</span> Time, r_max, K, N_0, t_lag), data,</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">t_lag=</span>t_lag_start, <span class="at">r_max=</span>r_max_start, <span class="at">N_0 =</span> N_0_start, <span class="at">K =</span> K_start))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You might one or more warning(s) that the model fitting iterations generated NaNs during the fitting procedure for these data (because at some point the NLLS fitting algorithm “wandered” to a combination of K and N_0 values that yields a NaN for log(K/N_0)).</p>
<p>You can ignore these warning in this case. But not always – sometimes these NaNs mean that the equation is wrongly written, or that it generates NaNs across the whole range of the x-values, in which case the model is inappropriate for these data.</p>
<p>Get the model summary:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_gompertz)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: LogN ~ gompertz_model(t = Time, r_max, K, N_0, t_lag)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)    
t_lag  4.80680    0.18433   26.08 5.02e-09 ***
r_max  1.86616    0.08749   21.33 2.45e-08 ***
N_0   10.39142    0.05998  173.24 1.38e-15 ***
K     15.54956    0.05056  307.57  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.09418 on 8 degrees of freedom

Number of iterations to convergence: 10 
Achieved convergence tolerance: 1.49e-08</code></pre>
</div>
</div>
<p>And see how the fits of the two nonlinear models compare:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>timepoints <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="fl">0.1</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>logistic_points <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">logistic_model</span>(<span class="at">t =</span> timepoints, </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">r_max =</span> <span class="fu">coef</span>(fit_logistic)[<span class="st">"r_max"</span>], </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">K =</span> <span class="fu">coef</span>(fit_logistic)[<span class="st">"K"</span>], </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">N_0 =</span> <span class="fu">coef</span>(fit_logistic)[<span class="st">"N_0"</span>]))</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>gompertz_points <span class="ot">&lt;-</span> <span class="fu">gompertz_model</span>(<span class="at">t =</span> timepoints, </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">r_max =</span> <span class="fu">coef</span>(fit_gompertz)[<span class="st">"r_max"</span>], </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">K =</span> <span class="fu">coef</span>(fit_gompertz)[<span class="st">"K"</span>], </span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">N_0 =</span> <span class="fu">coef</span>(fit_gompertz)[<span class="st">"N_0"</span>], </span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">t_lag =</span> <span class="fu">coef</span>(fit_gompertz)[<span class="st">"t_lag"</span>])</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(timepoints, logistic_points)</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>df1<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="st">"Logistic model"</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Time"</span>, <span class="st">"LogN"</span>, <span class="st">"model"</span>)</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(timepoints, gompertz_points)</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="st">"Gompertz model"</span></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Time"</span>, <span class="st">"LogN"</span>, <span class="st">"model"</span>)</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>model_frame <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df1, df2)</span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> LogN)) <span class="sc">+</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_line</span>(<span class="at">data =</span> model_frame, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> LogN, <span class="at">col =</span> model), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="co"># make the background white</span></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)<span class="sc">+</span> <span class="co"># make the plot square </span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"log(Abundance)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Clearly, the Gompertz model fits way better than the logistic growth equation in this case! Note also that there is a big difference in the fitted value of <span class="math inline">r_{max}</span> from the two models; the value is much lower from the Logistic model because it ignores the lag phase, including it into the exponential growth phase.</p>
<p>You can now perform model selection like you did above in the allometric scaling example.</p>
</section>
</section>
<section id="some-tips-and-tricks-for-nlls-fitting" class="level2">
<h2 class="anchored" data-anchor-id="some-tips-and-tricks-for-nlls-fitting">Some tips and tricks for NLLS fitting</h2>
<section id="starting-values" class="level3">
<h3 class="anchored" data-anchor-id="starting-values">Starting values</h3>
<p>The main challenge for NLLS fitting is finding starting (initial) values for the parameters, which the algorithm needs to proceed with the fitting/optimization. Inappropriate starting values can result in the algorithm finding parameter combinations represent convergence to a local optimum rather than the (globally) optimal solution. Starting parameter estimates can also result in or complete “divergence”, i.e., the search results in a combination of parameters that cause mathematical “singularity” (e.g., log(0) or division by zero).</p>
<section id="obtaining-them" class="level4">
<h4 class="anchored" data-anchor-id="obtaining-them">Obtaining them</h4>
<p>Finding the starting values is a <a href="https://en.wikipedia.org/wiki/Non-linear_least_squares#Initial_parameter_estimates">bit of an art</a>. There is no method for finding starting values that works universally (across different types of models).</p>
<p>The one universal rule though, is that finding starting values requires you to understand the meaning of each of the parameters in your model.</p>
<p>Furthermore, you will typically need to determine starting values <em>specific</em> to each model <em>and</em> each dataset that that you are wanting to fit that model to. To do so, understanding how each parameter in the model corresponds to features of the actual data is really necessary.</p>
<p>For example, in the Gompertz population growth rate model (eqn. {eq}<code>eq:Gompertz</code>), your starting values generator function would, for each dataset,<br>
* Calculate a starting value for <span class="math inline">r_{max}</span> by searching for the steepest slope of the growth curve (e.g., with a rolling OLS regression) * Calculate a starting value of <span class="math inline">t_{lag}</span> by intersecting the fitted line with the x (time)-axis * Calculate a starting value for the asymptote <span class="math inline">K</span> as the highest data (abundance) value in the dataset.</p>
<div class="cell">
<pre class="tip cell-code"><code>Ideally, you should write a separate a function that calculates starting values for the model parameters.</code></pre>
</div>
</section>
<section id="sampling-them" class="level4">
<h4 class="anchored" data-anchor-id="sampling-them">Sampling them</h4>
<p>Once you have worked out how to generate starting values for each non-linear model and dataset, a good next step for optimizing the fitting across multiple datasets (and thus maximize how many datasets are successfully fitted to the model) is to <em>rerun fitting attempts multiple times, sampling each of the starting values (simultaneously) randomly</em> (that is, randomly vary the set of starting values a bit each time). This sampling of starting values will increase the likelihood of&nbsp;the NLLS optimization algorithm finding a solution (optimal combination of parameters), and not getting stuck in&nbsp;a combination of parameters&nbsp;somewhere far away from that optimal solution.&nbsp;</p>
<p>In particular, * You can choose a Gaussian/Normal distribution if you have high confidence in mean value of parameter, or * You can uniform distribution if you have low confidence in the mean, but higher confidence in the range of values that the parameter can take. In both cases, the <em>mean</em> of the sampling distribution will be the starting value you inferred from the model and the data (previous section).</p>
<p>Furthermore, * Whichever distribution you choose (gaussian vs uniform), you will need to determine what range of values to restrict each parameter’s samples to. In the case of the normal distribution, this is determined by what standard deviation parameter (you choose), and in the case of the uniform distribution, this is determined by what lower and upper bound (you choose). Generally, a good approach is to set the bound to be some <em>percent</em> (say 5-10%) of the parameter’s (mean) starting value. In both cases the chosen range to restrict the sampling to would typically be some subset of the model’s <em>parameter bounds</em> (next section).<br>
* <em>How many times to re-run</em> the fitting for a single dataset and model?* – this depends on how “difficult” the model is, and how much computational power you have.</p>
<p>You may also try and use a more sophisticated approach such as <a href="https://en.wikipedia.org/wiki/Hyperparameter_optimization#Approaches">grid searching</a> for varying your starting values randomly.</p>
</section>
</section>
<section id="bounding-parameters-revisited" class="level3">
<h3 class="anchored" data-anchor-id="bounding-parameters-revisited">Bounding parameters revisited</h3>
<p>At the start, we looked at an exampleof NLLS fitting where we bounded the parameters. It can be a good idea to restrict the range of values that the each of the model’s parameters can take <em>during any one fitting/optimization run</em>. To&nbsp;“bound” a parameter in this way means to&nbsp;give it upper and lower limits.&nbsp;By doing so,&nbsp;during&nbsp;one optimization/fitting (e.g., one call to&nbsp;<code>nlsLM</code>, to fit one model, to one dataset), the fitting algorithm does not allow a parameter to go outside some&nbsp;limits. This reduces the chances of&nbsp;the&nbsp;optimization&nbsp;getting stuck too far from the solution, or failing completely due to some mathematical singularity (e.g., log(0)).</p>
<p>The bounds are typically fixed for each parameter of a model <em>at the level of the model</em> (e.g., they do not change based on each dataset). For example, in the Gompertz model for growth rates (eqn. {eq}<code>eq:Gompertz</code>), you can limit the growth rate parameter to never be negative (the bounds would be <span class="math inline">[0,\infty]</span>), or restrict it further to be some value between zero and an upper limit (say, 10) that you know organismal growth rates cannot exceed (the bounds would in this case would be <span class="math inline">[0,10]</span>).</p>
<p>However, as we saw in the Michaelis-Menten model fitting example, bounding the parameters too much (excessively narrow ranges) can result in poor solutions because the algorithm cannot explore sufficient parameter space.</p>
<div class="cell">
<pre class="tip cell-code"><code>The values of the parameter bounds you choose, of course, may depend on the *units of measurement* of the data. For example, in [SI](https://en.wikipedia.org/wiki/International_System_of_Units), growth rates in the Logistic or Gompertz models would be in units of 1/X).</code></pre>
</div>
<p>Irrespective of which computer language the NLLS fitting algorithm is implemented in (<code>nlsLM</code>&nbsp; in R or <code>lmfit</code> in Python), the fitting command/method will have options for setting the parameter bounds. In particular,</p>
<ul>
<li><p>For <code>nlsLM</code> in R, look up https://www.rdocumentation.org/packages/minpack.lm/versions/1.2-1/topics/nlsLM&nbsp;(the <code>lower</code>&nbsp;and <code>upper</code>&nbsp;arguments&nbsp;to the function).&nbsp;</p></li>
<li><p>For <code>lmfit</code> in Python, look up https://lmfit.github.io/lmfit-py/parameters.html&nbsp;(and in particular, https://lmfit.github.io/lmfit-py/parameters.html#lmfit.parameter.Parameter) (the <code>min</code>&nbsp;and <code>max</code>&nbsp;arguments).</p></li>
</ul>
<p><em>Bounding the parameter values has nothing to do, per se, with sampling the starting values&nbsp;of each parameter, though if you choose to sample starting values (explained in previous section), you need to make sure that the samples don’t exceed the pre-set bounds (explained in this section).</em></p>
<div class="cell">
<pre class="note cell-code"><code>Python's `lmfit` has an option to also internally vary the parameter. So by using a sampling approach as described in the previous section, *and* allowing the parameter to vary (note that `vary=True` is the default) within `lmfit`, you will be in essence be imposing sampling twice. This may or may not improve fitting performance &amp;ndash; try it out both ways.</code></pre>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">graphics.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have the background requirements going, we can start using the rTPC package (keep in mind in order to load the rTPC package you will need to use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("padpadpadpad/rTPC") ## to install rTPC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets look through the different models available!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">#take a look at the different models available</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_model_names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "beta_2012"             "boatman_2017"          "briere2_1999"         
 [4] "delong_2017"           "deutsch_2008"          "flinn_1991"           
 [7] "gaussian_1987"         "hinshelwood_1947"      "joehnk_2008"          
[10] "johnsonlewin_1946"     "kamykowski_1985"       "lactin2_1995"         
[13] "lrf_1991"              "modifiedgaussian_2006" "oneill_1972"          
[16] "pawar_2018"            "quadratic_2008"        "ratkowsky_1983"       
[19] "rezende_2019"          "sharpeschoolfull_1981" "sharpeschoolhigh_1981"
[22] "sharpeschoollow_1981"  "spain_1982"            "thomas_2012"          
[25] "thomas_2017"           "weibull_1995"         </code></pre>
</div>
</div>
<p>There are 24 models to choose from. For our purposes in this section we will be using the sharpesschoolhigh_1981 model. More information on the model can be found <a href="https://padpadpadpad.github.io/rTPC/reference/sharpeschoolhigh_1981.html">here</a>.</p>
<p>From here lets load in our data from the overall repository. This will be called <code>csm7I.csv</code>.</p>
<p>This is from the larger dataset reduced to a single trait. This data comes from the <a href="https://legacy.vectorbyte.org/">VectorBiTE database</a> and so has unique IDs. We will use this to get our species and trait of interest isolated from the larger dataset. In this example we will be looking at Development Rate across temperatures for Aedes albopictus, which we can find an example of in csm7I.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"activities/data/csm7I.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 11 Columns: 8
── Column specification
──────────────────────────────────────────────────────── Delimiter: "," chr
(5): originalid, originaltraitname, originaltraitunit, interactor1, cita... dbl
(3): ...1, originaltraitvalue, ambienttemp
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">'originalid'</span>, <span class="st">'originaltraitname'</span>, <span class="st">'originaltraitunit'</span>, <span class="st">'originaltraitvalue'</span>, <span class="st">'interactor1'</span>, <span class="st">'ambienttemp'</span>, <span class="st">'citation'</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(df1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now lets visualize our data in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co">#visualize</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(ambienttemp, originaltraitvalue))<span class="sc">+</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Temperature (ºC)'</span>,</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Development Rate'</span>,</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">'Development rate across temperatures for Aedes albopictus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We will need to write which model we are using (sharpschoolhigh_1981). From here we can actually build our fit. We will use ‘’nls_multstart’’ to automatically find our starting values. This lets us skip the <a href="https://mhasoba.github.io/TheMulQuaBio/notebooks/20-ModelFitting-NLLS.html#the-starting-values-problem">starting value problem</a>. From here we build our predicted line.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose model</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">=</span> <span class="st">'sharpschoolhigh_1981'</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>d<span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">temp =</span> ambienttemp,</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">rate =</span> originaltraitvalue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit Sharpe-Schoolfield model</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>d_fit <span class="ot">&lt;-</span> <span class="fu">nest</span>(d, <span class="at">data =</span> <span class="fu">c</span>(temp, rate)) <span class="sc">%&gt;%</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sharpeschoolhigh =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">nls_multstart</span>(rate<span class="sc">~</span><span class="fu">sharpeschoolhigh_1981</span>(<span class="at">temp =</span> temp, r_tref,e,eh,th, <span class="at">tref =</span> <span class="dv">15</span>),</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">data =</span> .x,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">iter =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">start_lower =</span> <span class="fu">get_start_vals</span>(.x<span class="sc">$</span>temp, .x<span class="sc">$</span>rate, <span class="at">model_name =</span> <span class="st">'sharpeschoolhigh_1981'</span>) <span class="sc">-</span> <span class="dv">10</span>,</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">start_upper =</span> <span class="fu">get_start_vals</span>(.x<span class="sc">$</span>temp, .x<span class="sc">$</span>rate, <span class="at">model_name =</span> <span class="st">'sharpeschoolhigh_1981'</span>) <span class="sc">+</span> <span class="dv">10</span>,</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">lower =</span> <span class="fu">get_lower_lims</span>(.x<span class="sc">$</span>temp, .x<span class="sc">$</span>rate, <span class="at">model_name =</span> <span class="st">'sharpeschoolhigh_1981'</span>),</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">upper =</span> <span class="fu">get_upper_lims</span>(.x<span class="sc">$</span>temp, .x<span class="sc">$</span>rate, <span class="at">model_name =</span> <span class="st">'sharpeschoolhigh_1981'</span>),</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">supp_errors =</span> <span class="st">'Y'</span>,</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">convergence_count =</span> <span class="cn">FALSE</span>)),</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>         <span class="co"># create new temperature data</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">new_data =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">tibble</span>(<span class="at">temp =</span> <span class="fu">seq</span>(<span class="fu">min</span>(.x<span class="sc">$</span>temp), <span class="fu">max</span>(.x<span class="sc">$</span>temp), <span class="at">length.out =</span> <span class="dv">100</span>))),</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>         <span class="co"># predict over that data,</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">preds =</span>  <span class="fu">map2</span>(sharpeschoolhigh, new_data, <span class="sc">~</span><span class="fu">augment</span>(.x, <span class="at">newdata =</span> .y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># unnest predictions</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>d_preds <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(d_fit, preds) <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets visualize the line:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot data and predictions</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(temp, .fitted), d_preds, <span class="at">col =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(temp, rate), d, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Temperature (ºC)'</span>,</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Growth rate'</span>,</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">'Growth rate across temperatures'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks like a good fit! We can start exploring using bootstrapping. Lets start with refitting the model using nlsLM.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># refit model using nlsLM</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>fit_nlsLM <span class="ot">&lt;-</span> minpack.lm<span class="sc">::</span><span class="fu">nlsLM</span>(rate<span class="sc">~</span><span class="fu">sharpeschoolhigh_1981</span>(<span class="at">temp =</span> temp, r_tref,e,eh,th, <span class="at">tref =</span> <span class="dv">15</span>),</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> d,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">start =</span> <span class="fu">coef</span>(d_fit<span class="sc">$</span>sharpeschoolhigh[[<span class="dv">1</span>]]),</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">lower =</span> <span class="fu">get_lower_lims</span>(d<span class="sc">$</span>temp, d<span class="sc">$</span>rate, <span class="at">model_name =</span> <span class="st">'sharpeschoolhigh_1981'</span>),</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">upper =</span> <span class="fu">get_upper_lims</span>(d<span class="sc">$</span>temp, d<span class="sc">$</span>rate, <span class="at">model_name =</span> <span class="st">'sharpeschoolhigh_1981'</span>),</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="at">times =</span> <span class="fu">nrow</span>(d)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can actually bootstrap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># bootstrap using case resampling</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>boot1 <span class="ot">&lt;-</span> <span class="fu">Boot</span>(fit_nlsLM, <span class="at">method =</span> <span class="st">'case'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in nls.lm(par = start, fn = FCT, jac = jac, control = control, lower = lower, : lmdif: info = -1. Number of iterations has reached `maxiter' == 50.</code></pre>
</div>
</div>
<p>It is a good idea to explore the data again now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the data</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(boot1<span class="sc">$</span>t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         r_tref        e       eh       th
[1,] 0.07156528 1.127725 1.569427 31.16678
[2,] 0.07428071 1.101990 1.460402 31.08500
[3,] 0.08116097 0.836633 2.145525 36.54408
[4,] 0.07897508 1.344105 1.338908 25.50450
[5,] 0.07328032 1.179788 1.422640 29.40599
[6,] 0.07039726 1.107672 1.653070 31.40087</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(boot1, <span class="at">layout =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in norm.inter(t, adj.alpha): extreme order statistics used as endpoints

Warning in norm.inter(t, adj.alpha): extreme order statistics used as endpoints</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we use the bootstrapped model to build predictions which we can explore visually.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create predictions of each bootstrapped model</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>boot1_preds <span class="ot">&lt;-</span> boot1<span class="sc">$</span>t <span class="sc">%&gt;%</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do</span>(<span class="fu">data.frame</span>(<span class="at">temp =</span> <span class="fu">seq</span>(<span class="fu">min</span>(d<span class="sc">$</span>temp), <span class="fu">max</span>(d<span class="sc">$</span>temp), <span class="at">length.out =</span> <span class="dv">100</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">sharpeschoolhigh_1981</span>(temp, r_tref, e, eh, th, <span class="at">tref =</span> <span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate bootstrapped confidence intervals</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>boot1_conf_preds <span class="ot">&lt;-</span> <span class="fu">group_by</span>(boot1_preds, temp) <span class="sc">%&gt;%</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">conf_lower =</span> <span class="fu">quantile</span>(pred, <span class="fl">0.025</span>),</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">conf_upper =</span> <span class="fu">quantile</span>(pred, <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot bootstrapped CIs</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(temp, .fitted), d_preds, <span class="at">col =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(temp, <span class="at">ymin =</span> conf_lower, <span class="at">ymax =</span> conf_upper), boot1_conf_preds, <span class="at">fill =</span> <span class="st">'blue'</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(temp, rate), d, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Temperature (ºC)'</span>,</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Growth rate'</span>,</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">'Growth rate across temperatures'</span>)</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plot bootstrapped predictions</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(temp, .fitted), d_preds, <span class="at">col =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(temp, pred, <span class="at">group =</span> iter), boot1_preds, <span class="at">col =</span> <span class="st">'blue'</span>, <span class="at">alpha =</span> <span class="fl">0.007</span>) <span class="sc">+</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(temp, rate), d, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Temperature (ºC)'</span>,</span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Growth rate'</span>,</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">'Growth rate across temperatures'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-80-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see here that when we bootstrap this data, the fit is not as good as we would expect from the initial exploration. We do not necessarily get a good thermal optima from this data with confidence intervals from this data.</p>
<p>Lets look at a second example:</p>
</section>
</section>
</section>
<section id="example-aedes-aegypti-juvenile-mortality-rate" class="level1">
<h1>Example: Aedes aegypti Juvenile Mortality Rate</h1>
<p>Juvenile mortality and development are important traits for population growth (<span class="math inline">r_{max}</span>), particularly in organisms with complex life histories, such as arthropods(<a href="https://www.frontiersin.org/articles/10.3389/fevo.2020.00189/full">Cator et al (2020)</a>; <a href="https://royalsocietypublishing.org/doi/full/10.1098/rspb.2020.3217?casa_token=eG00HSjUNDAAAAAA%3Ah2_CuvKoI8WFiBCT3J9bZ6PnkgN-jLnwZnmIbsNY_hSozTS54_4UhFzuSMKeO_xDySM57S3CuJZJwQ">Huxley et al.&nbsp;2021</a>). The thermal optima of these functional traits can provide important insights into the suitability of environmental conditions for a species’ establishment and persistence. This information is particularly important when predicting environmental suitability for the establishment of disease vectors, such as <span class="math inline">Aedes</span> <span class="math inline">aegypti</span>.</p>
<p>For this example, we will use a dataset from VectorBiTE <code>juvenilemortalityrateae.csv</code>.</p>
<p>Lets start by loading the dataset and getting set up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="fu">graphics.off</span>()</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>ae.ae <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'activities/data/juvenilemortalityrateae.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 55 Columns: 10
── Column specification
──────────────────────────────────────────────────────── Delimiter: "," chr
(6): originaltraitname, originaltraitunit, standardisedtraitname, standa... dbl
(4): ...1, originaltraitvalue, standardisedtraitvalue, temp
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
</div>
<p>We will need to manipulate this one a bit to get at the data we want.</p>
<p>Let’s subset the data by filtering by trait:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>ae.zj <span class="ot">&lt;-</span> ae.ae <span class="sc">%&gt;%</span> <span class="fu">filter</span>(standardisedtraitname <span class="sc">==</span> <span class="st">"Juvenile Mortality Rate"</span>)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>ae.zj <span class="ot">&lt;-</span> ae.zj <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(standardisedtraitvalue,temp)</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>ae.zj <span class="ot">&lt;-</span> ae.zj <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">rate =</span> standardisedtraitvalue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Time to visualize!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ae.zj<span class="sc">$</span>temp, ae.zj<span class="sc">$</span>rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This doesn’t look good. In order to fit the rTPC models to a mortality rate we will need to invert either the model or the data. It is easiest to invert the data so we will use the following code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>ae.zj<span class="sc">$</span>rate <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>ae.zj<span class="sc">$</span>rate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ae.zj<span class="sc">$</span>temp, ae.zj<span class="sc">$</span>rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is better! We can fit a curve to this data and decide a thermal optima. We need to start with the start values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>start_vals <span class="ot">&lt;-</span> <span class="fu">get_start_vals</span>(ae.zj<span class="sc">$</span>temp, ae.zj<span class="sc">$</span>rate, <span class="at">model_name =</span> <span class="st">'pawar_2018'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we fit the model to the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>a_fits <span class="ot">&lt;-</span> <span class="fu">nest</span>(ae.zj, <span class="at">data =</span> <span class="fu">c</span>(temp, rate)) <span class="sc">%&gt;%</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pawar =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">nls_multstart</span>(rate<span class="sc">~</span><span class="fu">pawar_2018</span>(<span class="at">temp =</span> temp, r_tref,e,eh,topt, <span class="at">tref =</span> <span class="dv">15</span>),</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">data =</span> .x,</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">iter =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">start_lower =</span> start_vals <span class="sc">-</span> <span class="dv">10</span>,</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">start_upper =</span> start_vals <span class="sc">+</span> <span class="dv">10</span>,</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">supp_errors =</span> <span class="st">'Y'</span>,</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">convergence_count =</span> <span class="cn">FALSE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll need to build predictions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>a_preds <span class="ot">&lt;-</span> <span class="fu">mutate</span>(a_fits, <span class="at">new_data =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">tibble</span>(<span class="at">temp =</span> <span class="fu">seq</span>(<span class="fu">min</span>(.x<span class="sc">$</span>temp), <span class="fu">max</span>(.x<span class="sc">$</span>temp), <span class="at">length.out =</span> <span class="dv">100</span>))))<span class="sc">%&gt;%</span> </span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get rid of original data column</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(., <span class="sc">-</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stack models into a single column, with an id column for model_name</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(., <span class="at">names_to =</span> <span class="st">'model_name'</span>, <span class="at">values_to =</span> <span class="st">'fit'</span>, <span class="fu">c</span>(pawar)) <span class="sc">%&gt;%</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create new list column containing the predictions</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this uses both fit and new_data list columns</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">preds =</span> <span class="fu">map2</span>(fit, new_data, <span class="sc">~</span><span class="fu">augment</span>(.x, <span class="at">newdata =</span> .y))) <span class="sc">%&gt;%</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only the columns we want to keep</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(model_name, preds) <span class="sc">%&gt;%</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># unlist the preds list column</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And plot those predictions to the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(a_preds) <span class="sc">+</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(temp, .fitted, <span class="at">col =</span> model_name)) <span class="sc">+</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(temp, rate),<span class="at">size=</span><span class="fl">0.2</span>,<span class="at">alpha=</span><span class="fl">0.5</span>, ae.zj)<span class="sc">+</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'none'</span>) <span class="sc">+</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">'qual'</span>, <span class="at">palette =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Temperature (°C)'</span>,</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'rate'</span>,</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">'Dev rate thermal performance curves'</span>)<span class="sc">+</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>)<span class="sc">+</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-89-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Looking good! Now let’s use the model to generate 95% confidence bounds for the model predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>fit_nlsLM2 <span class="ot">&lt;-</span> minpack.lm<span class="sc">::</span><span class="fu">nlsLM</span>(rate<span class="sc">~</span><span class="fu">pawar_2018</span>(<span class="at">temp =</span> temp, r_tref,e,eh,topt, <span class="at">tref =</span> <span class="dv">15</span>),</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">data =</span> ae.zj,</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">start =</span> <span class="fu">coef</span>(a_fits<span class="sc">$</span>pawar[[<span class="dv">1</span>]]),</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weights =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="at">times =</span> <span class="fu">nrow</span>(ae.zj)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># bootstrap using case resampling</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>boot2 <span class="ot">&lt;-</span> <span class="fu">Boot</span>(fit_nlsLM2, <span class="at">method =</span> <span class="st">'residual'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in nls.lm(par = start, fn = FCT, jac = jac, control = control, lower = lower, : lmdif: info = -1. Number of iterations has reached `maxiter' == 50.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>boot2_preds <span class="ot">&lt;-</span> boot2<span class="sc">$</span>t <span class="sc">%&gt;%</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do</span>(<span class="fu">data.frame</span>(<span class="at">temp =</span> <span class="fu">seq</span>(<span class="fu">min</span>(ae.zj<span class="sc">$</span>temp), <span class="fu">max</span>(ae.zj<span class="sc">$</span>temp), <span class="at">length.out =</span> <span class="dv">100</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">pawar_2018</span>(temp, r_tref, e, eh, topt, <span class="at">tref =</span> <span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate bootstrapped confidence intervals</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>boot2_conf_preds <span class="ot">&lt;-</span> <span class="fu">group_by</span>(boot2_preds, temp) <span class="sc">%&gt;%</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">conf_lower =</span> <span class="fu">quantile</span>(pred, <span class="fl">0.025</span>),</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">conf_upper =</span> <span class="fu">quantile</span>(pred, <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot bootstrapped CIs</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(temp, .fitted), a_preds, <span class="at">col =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(temp, <span class="at">ymin =</span> conf_lower, <span class="at">ymax =</span> conf_upper), boot2_conf_preds, <span class="at">fill =</span> <span class="st">'blue'</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(temp, rate), ae.zj, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Temperature (°C)'</span>,</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'1/zj'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-93-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see on this plot, it looks like we will actually get an upper and lower confidence interval! If we eye the plot as it is we can see that the thermal optima will probably land around 15-16 degrees celcius but lets find it specifically.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate params with CIs</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>extra_params2 <span class="ot">&lt;-</span> <span class="fu">calc_params</span>(fit_nlsLM2) <span class="sc">%&gt;%</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span>  <span class="st">'param'</span>, <span class="at">values_to =</span> <span class="st">'estimate'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>ci_extra_params2 <span class="ot">&lt;-</span> <span class="fu">Boot</span>(fit_nlsLM2, <span class="at">f =</span> <span class="cf">function</span>(x){<span class="fu">unlist</span>(<span class="fu">calc_params</span>(x))}, </span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">labels =</span> <span class="fu">names</span>(<span class="fu">calc_params</span>(fit_nlsLM2)), <span class="at">R =</span> <span class="dv">200</span>, <span class="at">method =</span> <span class="st">'residual'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">confint</span>(., <span class="at">method =</span> <span class="st">'bca'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">conf_lower =</span> <span class="dv">1</span>, <span class="at">conf_upper =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(., <span class="at">var =</span> <span class="st">'param'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="st">'residual bootstrap'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Number of bootstraps was 0 out of 200 attempted </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in norm.inter(t, adj.alpha): extreme order statistics used as endpoints</code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>ci_extra_params2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(ci_extra_params2, extra_params2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(param)`</code></pre>
</div>
</div>
<p>It’s okay to get a warning here the code is still working fine and we will get good findings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co">#- Topt </span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>topt2 <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(ci_extra_params2[<span class="dv">2</span>,])</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>topt2<span class="sc">$</span>species <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="st">"Aedes aegypti"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s look at the results!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(topt2, <span class="fu">aes</span>(estimate, species)) <span class="sc">+</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conf_lower, <span class="at">xmax =</span> conf_upper)) <span class="sc">+</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">''</span>) <span class="sc">+</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'calculation of Topt with CIs'</span>,</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">'dev rate TPC; using residual resampling'</span>)<span class="sc">+</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_NLLS_activity_files/figure-html/unnamed-chunk-97-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks good, we have now have the estimated thermal optimum for juvenile mortality rate with 95% confidence bounds! In other words, our model predicts that juvenile survival in <span class="math inline">Ae.</span> <span class="math inline">aegypti</span> is highest when environmental temperatures range between 12°C and 16°C.</p>
<p>Please see Daniel Padfields <a href="https://padpadpadpad.github.io/rTPC/articles/rTPC.html">git</a> for more information on using the rTPC package.</p>
<section id="readings-and-resources" class="level2">
<h2 class="anchored" data-anchor-id="readings-and-resources">Readings and Resources</h2>
<ul>
<li><p>Motulsky, Harvey, and Arthur Christopoulos. Fitting models to biological data using linear and nonlinear regression: a practical guide to curve fitting. OUP USA, 2004: <a href="https://www.facm.ucl.ac.be/cooperation/Vietnam/WBI-Vietnam-October-2011/Modelling/RegressionBook.pdf" class="uri">https://www.facm.ucl.ac.be/cooperation/Vietnam/WBI-Vietnam-October-2011/Modelling/RegressionBook.pdf</a></p></li>
<li><p>These are a pretty good series of notes on NLLS (even if you are using R instead of Python): <a href="https://lmfit.github.io/lmfit-py/intro.html" class="uri">https://lmfit.github.io/lmfit-py/intro.html</a></p></li>
<li><p>Another technical description of NLLS algorithms: <a href="https://www.gnu.org/software/gsl/doc/html/nls.html" class="uri">https://www.gnu.org/software/gsl/doc/html/nls.html</a></p></li>
<li><p>Johnson, J. B. &amp; Omland, K. S. 2004 Model selection in ecology and evolution. Trends Ecol. Evol. 19, 101–108.</p></li>
<li><p>The <em>nlstools</em> package for NLLS fit diagnostics: <a href="https://rdrr.io/rforge/nlstools" class="uri">https://rdrr.io/rforge/nlstools</a></p>
<ul>
<li>The original paper: <a href="http://dx.doi.org/10.18637/jss.v066.i05" class="uri">http://dx.doi.org/10.18637/jss.v066.i05</a></li>
</ul></li>
</ul>
</section>
<section id="practice-problem-for-nlls" class="level2">
<h2 class="anchored" data-anchor-id="practice-problem-for-nlls">Practice Problem for NLLS</h2>
<section id="the-nllsdataset.csv-dataset-contains-values-on-trait-temperature-relationships-in-three-important-vectorpest-species.-fit-thermal-performance-curves-to-traits-of-interest.-use-bootstrapping-to-generate-confidence-bounds-for-each-curve." class="level4">
<h4 class="anchored" data-anchor-id="the-nllsdataset.csv-dataset-contains-values-on-trait-temperature-relationships-in-three-important-vectorpest-species.-fit-thermal-performance-curves-to-traits-of-interest.-use-bootstrapping-to-generate-confidence-bounds-for-each-curve.">The <code>nllsdataset.csv</code> dataset contains values on trait-temperature relationships in three important vector/pest species. Fit thermal performance curves to trait(s) of interest. Use bootstrapping to generate confidence bounds for each curve.</h4>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>